import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { InputOTP, InputOTPGroup, InputOTPSlot } from "@/components/ui/input-otp";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Input, Label, Button, toast } from "@/components/ui";
import { KeyRound, Lock } from "lucide-react";
import { Email, Google, Password, Anonymous, convexAuth } from "convex-react";
import { useEffect, useState } from "react";

const emailOtp = Email({
  id: "email-otp",
  // ...
});

export const { auth, signIn, signOut, store, isAuthenticated } = convexAuth({
  providers: [Google, Password({ reset: emailOtp }), emailOtp, Anonymous],
});

// Use the password provider's reset flow to generate a token compatible with reset-verification
formData.set("flow", "reset");
await signIn("password", formData);

const [newPassword, setNewPassword] = useState("");
const [confirmPassword, setConfirmPassword] = useState("");
const [isSettingPassword, setIsSettingPassword] = useState(false);
const [otp, setOtp] = useState("");
const [otpSent, setOtpSent] = useState(false);

useEffect(() => {
  const handleSetPassword = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (newPassword.length < 8) {
      toast.error("Password must be at least 8 characters");
      return;
    }
    
    if (newPassword !== confirmPassword) {
      toast.error("Passwords do not match");
      return;
    }

    if (!userProfile?.email) {
      toast.error("User email not found");
      return;
    }
    
    setIsSettingPassword(true);
    try {
      if (!otpSent) {
        // Step 1: Send OTP using reset flow
        await signIn("password", { 
          flow: "reset", 
          email: userProfile.email 
        });
        setOtpSent(true);
        toast.success("Verification code sent to your email");
      } else {
        // Step 2: Verify OTP and set password
        if (otp.length !== 6) {
          toast.error("Please enter the 6-digit verification code");
          setIsSettingPassword(false);
          return;
        }

        await signIn("password", { 
          flow: "reset-verification", 
          email: userProfile.email,
          code: otp,
          password: newPassword 
        });
        
        toast.success("Password set successfully! You can now login with email and password.");
        setNewPassword("");
        setConfirmPassword("");
        setOtp("");
        setOtpSent(false);
      }
    } catch (error) {
      console.error("Failed to set password:", error);
      toast.error("Failed to set password. " + (error instanceof Error ? error.message : "Please try again."));
    } finally {
      setIsSettingPassword(false);
    }
  };

  const calculateCompletion = () => {
    if (!userProfile?.email) return 0;
    if (isSettingPassword) return 100;
    if (otpSent && otp.length === 6) return 100;
    return 0;
  };

  const handleOtpRequest = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    setIsLoading(true);
    setError(null);
    
    try {
      const formData = new FormData(event.currentTarget);
      const email = (formData.get("email") as string).toLowerCase().trim();
      
      // Use the password provider's reset flow to generate a token compatible with reset-verification
      formData.set("flow", "reset");
      await signIn("password", formData);
      
      setStep({ email, mode: "otp" });
    } catch (error) {
      // Handle error
    } finally {
      setIsLoading(false);
    }
  };

  {/* Password Management Section */}
  <div className="space-y-2 border-t border-white/20 pt-6">
    <Label className="text-white flex items-center gap-2">
      <Lock className="h-4 w-4" />
      Set Password
    </Label>
    <p className="text-white/60 text-xs mb-4">
      Set a password to login with your email address.
    </p>
    
    <div className="bg-white/5 border border-white/10 rounded-xl p-6 space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label htmlFor="newPassword" className="text-white text-sm">New Password</Label>
          <Input
            id="newPassword"
            type="password"
            value={newPassword}
            onChange={(e) => setNewPassword(e.target.value)}
            placeholder="Enter new password"
            className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
            disabled={otpSent}
          />
        </div>
        <div className="space-y-2">
          <Label htmlFor="confirmPassword" className="text-white text-sm">Confirm Password</Label>
          <Input
            id="confirmPassword"
            type="password"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            placeholder="Confirm new password"
            className="bg-white/10 border-white/20 text-white placeholder:text-white/50"
            disabled={otpSent}
          />
        </div>
      </div>

      {otpSent && (
        <div className="space-y-2 animate-in fade-in slide-in-from-top-2">
          <Label className="text-white text-sm">Verification Code</Label>
          <p className="text-white/60 text-xs">Please enter the code sent to {userProfile.email}</p>
          <div className="flex justify-start">
            <InputOTP
              value={otp}
              onChange={setOtp}
              maxLength={6}
            >
              <InputOTPGroup className="gap-2">
                {Array.from({ length: 6 }).map((_, index) => (
                  <InputOTPSlot 
                    key={index} 
                    index={index}
                    className="bg-white/10 border border-white/20 text-white w-10 h-10 rounded-lg"
                  />
                ))}
              </InputOTPGroup>
            </InputOTP>
          </div>
        </div>
      )}
      
      <div className="flex gap-3">
        <Button
          type="button"
          onClick={handleSetPassword}
          disabled={isSettingPassword || !newPassword || !confirmPassword || (otpSent && otp.length !== 6)}
          className="w-full md:w-auto bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white"
        >
          {isSettingPassword ? (
            <>{otpSent ? "Verifying..." : "Sending Code..."}</>
          ) : (
            <>
              <KeyRound className="h-4 w-4 mr-2" />
              {otpSent ? "Verify & Set Password" : "Set Password"}
            </>
          )}
        </Button>
        
        {otpSent && (
          <Button
            type="button"
            variant="outline"
            onClick={() => {
              setOtpSent(false);
              setOtp("");
            }}
            className="bg-transparent border-white/20 text-white hover:bg-white/10"
          >
            Cancel
          </Button>
        )}
      </div>
    </div>
  </div>

  {/* Helper Text */}
  <p className="text-white/40 text-xs mt-2">
    {isSettingPassword ? "Setting up your password..." : "No password set yet"}
  </p>
</div>