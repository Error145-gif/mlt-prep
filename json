{"file_path": "src/convex/authHelpers.ts", "content": "import { getAuthUserId } from \"@convex-dev/auth/server\";\nimport { mutation, internalMutation } from \"./_generated/server\";\nimport { v } from \"convex/values\";\n\n// Auto-register user after successful OTP verification during account creation\nexport const autoCompleteRegistration = mutation({\n  args: {},\n  handler: async (ctx) => {\n    const userId = await getAuthUserId(ctx);\n    if (!userId) {\n      return null;\n    }\n\n    const user = await ctx.db.get(userId);\n    if (!user) {\n      return null;\n    }\n\n    const updates: any = {};\n    let needsUpdate = false;\n\n    // Check identity provider to set hasPassword\n    const identity = await ctx.auth.getUserIdentity();\n    if (identity && identity.provider === \"password\" && !user.hasPassword) {\n      updates.hasPassword = true;\n      needsUpdate = true;\n    }\n\n    // Mark as registered if not already registered\n    if (!user.isRegistered) {\n      updates.isRegistered = true;\n      updates.registrationCompleted = true;\n      \n      if (!user.role) {\n        updates.role = \"user\";\n      }\n      needsUpdate = true;\n\n      // Automatically create 7-day free trial subscription for new users\n      const existingSubscription = await ctx.db\n        .query(\"subscriptions\")\n        .withIndex(\"by_user\", (q) => q.eq(\"userId\", userId))\n        .first();\n\n      if (!existingSubscription) {\n        const startDate = Date.now();\n        const endDate = startDate + 7 * 24 * 60 * 60 * 1000; // 7 days\n\n        await ctx.db.insert(\"subscriptions\", {\n          userId: userId,\n          planName: \"7-Day Free Trial\",\n          status: \"active\",\n          startDate,\n          endDate,\n          amount: 0,\n        });\n\n        console.log(`Auto-activated 7-day free trial for user: ${userId}`);\n      }\n    }\n\n    // Send welcome email to ALL users who haven't received it yet\n    // Removed time window restriction to ensure delivery\n    console.log(`[WELCOME EMAIL DIAGNOSIS] User ID: ${userId}, Email: ${user.email}, welcomeEmailSent: ${user.welcomeEmailSent}`);\n\n    if (!user.welcomeEmailSent && user.email) {\n      console.log(`[WELCOME EMAIL] ðŸš€ Triggering for user: ${userId}, email: ${user.email}`);\n      \n      const { internal } = await import(\"./_generated/api\");\n      \n      // Schedule email immediately\n      await ctx.scheduler.runAfter(0, internal.emails.sendWelcomeEmail, {\n        email: user.email,\n        name: user.name || \"there\",\n        userId: userId,\n      });\n      \n      console.log(`[WELCOME EMAIL] âœ… Scheduled successfully for: ${user.email}`);\n    } else {\n      console.log(`[WELCOME EMAIL] âŒ NOT scheduled. welcomeEmailSent=${user.welcomeEmailSent}, hasEmail=${!!user.email}`);\n    }\n\n    if (needsUpdate) {\n      await ctx.db.patch(userId, updates);\n    }\n\n    return userId;\n  },\n});\n\n// Internal mutation to mark welcome email as sent\nexport const markWelcomeEmailSent = internalMutation({\n  args: {\n    userId: v.id(\"users\"),\n  },\n  handler: async (ctx, args) => {\n    await ctx.db.patch(args.userId, {\n      welcomeEmailSent: true,\n    });\n  },\n});"}
